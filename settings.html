<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lexfall Settings</title>
  <style>
    :root { --bg:#f0f0f0; --panel:#ffffff; --text:#111; --muted:#333; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); margin:0; padding:16px; }
    .panel { background:var(--panel); max-width:420px; margin:12px auto; padding:16px; border-radius:12px; }
    h2 { margin:0 0 12px; font-size:1.2rem; text-align:center; }
    .row { display:flex; align-items:center; gap:10px; margin:10px 0; }
    label { display:block; font-weight:600; margin:10px 0 6px; }
    input[type=number] { width:100%; max-width:120px; padding:.5em .6em; }
    .actions { display:flex; gap:10px; justify-content:center; margin-top:14px; }
    button, a.button { padding:.8em 1.1em; border:none; border-radius:10px; background:#1f6feb; color:#fff; text-decoration:none; cursor:pointer; }
    a.secondary { background:#666; }
    .note { color:var(--muted); font-size:.92em; opacity:.85; }

    /* Auto: follow OS when in auto mode (no explicit class) */
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0f1115; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; }
    }
    /* Force dark */
    .theme-dark { --bg:#0f1115; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; }
    /* Force light (overrides OS dark) */
    .theme-light { --bg:#f0f0f0; --panel:#ffffff; --text:#111; --muted:#333; }

    /* High contrast preview (overrides theme for accessibility) */
    .high-contrast { background:#ffffff !important; color:#000000 !important; }
    .high-contrast .panel { background:#ffffff !important; color:#000000 !important; border:2px solid #000000; }
    .high-contrast h2,
    .high-contrast label,
    .high-contrast .note { color:#000000 !important; opacity:1 !important; }
    .high-contrast input,
    .high-contrast select { background:#ffffff !important; color:#000000 !important; border:2px solid #000000 !important; }
    .high-contrast button,
    .high-contrast a.button { background:#000000 !important; color:#ffffff !important; border:3px solid #000000 !important; }
    .high-contrast a.secondary { background:#666666 !important; }
  </style>
</head>
<body>
  <div class="panel">
    <h2>Settings</h2>
    <label for="minLen">Minimum word length</label>
    <div class="row">
      <input id="minLen" type="number" min="2" max="16" step="1"/>
      <span class="note">(Dictionary min is 2)</span>
    </div>
    <label class="row"><input id="autoConfirm" type="checkbox"/> Auto-confirm on slide release</label>
    <label class="row"><input id="noAnim" type="checkbox"/> Disable animations (for e-ink devices)</label>
    <label class="row"><input id="highContrast" type="checkbox"/> High contrast mode</label>
    <label class="row"><input id="debug" type="checkbox"/> Debug mode</label>
    <label>Theme</label>
    <div class="row" role="radiogroup" aria-label="Theme">
      <label class="row" style="margin:0; gap:6px;"><input type="radio" name="theme" value="light" id="themeLight"> Light</label>
      <label class="row" style="margin:0; gap:6px;"><input type="radio" name="theme" value="auto" id="themeAuto"> Auto</label>
      <label class="row" style="margin:0; gap:6px;"><input type="radio" name="theme" value="dark" id="themeDark"> Dark</label>
    </div>
    <div class="actions">
      <button id="save">Save</button>
      <a class="button secondary" href="lexfall.html">Back</a>
    </div>
  </div>

<script>
(function(){
  // Kindle device detection
  var isKindle = (function(){ 
    try { 
      var ua = (navigator.userAgent || '').toLowerCase(); 
      return /kindle|silk|kfw|kfa|kft|kfj|kfm|kfx|kfk|kfv|kfs|kfg|kfp/.test(ua); 
    } catch(e){ 
      return false; 
    }
  })();

  var settings = { minLen: 3, autoConfirm: true, noAnim: false, highContrast: false, debug: false, theme: 'auto' };
  try {
    var raw = localStorage.getItem('lexfall_settings');
    if (raw) {
      var s = JSON.parse(raw);
      if (s && typeof s.minLen === 'number') settings.minLen = Math.max(2, Math.min(16, s.minLen));
      if (typeof s.autoConfirm === 'boolean') settings.autoConfirm = s.autoConfirm;
      if (typeof s.noAnim === 'boolean') settings.noAnim = s.noAnim;
      if (typeof s.highContrast === 'boolean') settings.highContrast = s.highContrast;
      if (typeof s.debug === 'boolean') settings.debug = s.debug;
      if (typeof s.theme === 'string' && /^(light|auto|dark)$/.test(s.theme)) settings.theme = s.theme;
    }
  } catch(e){}

  var inputMinLen = document.getElementById('minLen');
  var inputAuto = document.getElementById('autoConfirm');
  var inputNoAnim = document.getElementById('noAnim');
  var inputHighContrast = document.getElementById('highContrast');
  var inputDebug = document.getElementById('debug');
  var themeLight = document.getElementById('themeLight');
  var themeAuto = document.getElementById('themeAuto');
  var themeDark = document.getElementById('themeDark');
  
  inputMinLen.value = settings.minLen;
  inputAuto.checked = !!settings.autoConfirm;
  inputNoAnim.checked = !!settings.noAnim;
  inputHighContrast.checked = !!settings.highContrast;
  inputDebug.checked = !!settings.debug;
  // theme radio
  (settings.theme === 'light' ? themeLight : settings.theme === 'dark' ? themeDark : themeAuto).checked = true;

  function applyThemePreview() {
    document.body.classList.remove('theme-light','theme-dark','high-contrast');
    // High contrast overrides theme for preview
    if (inputHighContrast.checked) {
      document.body.classList.add('high-contrast');
      return;
    }
    if (themeLight.checked) document.body.classList.add('theme-light');
    else if (themeDark.checked) document.body.classList.add('theme-dark');
    // Auto: no class, OS decides via media query
  }

  // Apply initial preview
  applyThemePreview();

  // Live preview on user changes
  themeLight.addEventListener('change', applyThemePreview);
  themeAuto.addEventListener('change', applyThemePreview);
  themeDark.addEventListener('change', applyThemePreview);
  inputHighContrast.addEventListener('change', applyThemePreview);

  // For Kindle devices, auto-check and disable high contrast mode
  if (isKindle) {
    inputHighContrast.checked = true;
    inputHighContrast.disabled = true;
  }

  document.getElementById('save').addEventListener('click', function(){
    var next = {
      minLen: Math.max(2, Math.min(16, parseInt(inputMinLen.value||'3',10))),
      autoConfirm: !!inputAuto.checked,
      noAnim: !!inputNoAnim.checked,
      highContrast: !!inputHighContrast.checked,
      debug: !!inputDebug.checked,
      theme: (themeLight.checked ? 'light' : themeDark.checked ? 'dark' : 'auto')
    };
    
    // For Kindle devices, ensure high contrast is always enabled
    if (isKindle) {
      next.highContrast = true;
    }
    
    try { localStorage.setItem('lexfall_settings', JSON.stringify(next)); } catch(e){}
    // simple feedback and go back
    window.location.href = 'lexfall.html';
  });
})();
</script>
</body>
</html>
